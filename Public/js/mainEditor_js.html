<script>
const rowIndexInput = document.getElementById('rowIndex');
// const fileInput = document.getElementById('fileInput');

const originImage = document.getElementById('originImage');
const processedImage = document.getElementById('processedImage');

const geometoryCompContainer = document.getElementById('geometoryComp');
const colorCompContainer = document.getElementById('colorComp');

const loadings = document.getElementsByClassName('loading');

const brightnessRange = document.getElementById('brightness');
const contrastRange = document.getElementById('contrast');
const saturationRange = document.getElementById('saturation');
const checkOriginImageBtn = document.getElementById('checkOriginImageBtn');

const areaInput = document.getElementById('area');
const prefectureInput = document.getElementById('prefecture');
const cityInput = document.getElementById('city');
const cityHiraganaInput = document.getElementById('cityHiragana');

const datetimeElement = document.getElementById('datetime');
const latitudeElement = document.getElementById('latitude');
const longitudeElement = document.getElementById('longitude');

const colorCheckbox = document.getElementById('color');
const charaCheckbox = document.getElementById('chara');
const pokefutaCheckbox = document.getElementById('pokefuta');
const designedCheckbox = document.getElementById('design');
const reliabilityCheckbox = document.getElementById('reliability');

let rowIndex = -1;
// let fileName = "";
let cropper = null;
let exifData = null;
let brightness = 0;
let contrast = 1;
let saturation = 1;


function showLoading() {
    for (var i = 0; i < loadings.length; i++) 
        loadings[i].style.display = "block";
}
function unshowLoading() {
    for (var i = 0; i < loadings.length; i++) 
        loadings[i].style.display = "none";
}

// ファイル名から撮影日時を取得する（失敗：null）
function getDateTimeFromFileName(filename) {
    let retVal = undefined;
    const regex = /@([-0-9.]+),([-0-9.]+),([0-9.]+z)/;  // fixme
    const match = filename.match(regex);
    if (match) {
        retVal = match[1];
    } 
    return retVal;
}


// 画像の情報を取得する
function extractExifData(dataUrl) {
    // データURLを取得
    exifData = piexif.load(dataUrl);
    delete exifData["0th"]["274"];
    console.log(exifData);
    // 撮影日時を取得
    const datetimeOriginal = exifData["Exif"]["36867"];
    const datetime = datetimeOriginal || '情報なし';
    // 緯度経度情報を取得
    const gps = exifData["GPS"];
    const latitude = gps[piexif.GPSIFD.GPSLatitude] || '情報なし';
    const longitude = gps[piexif.GPSIFD.GPSLongitude] || '情報なし';
    // 撮影日時を表示
    datetimeElement.textContent = datetime;
    // 緯度経度情報を表示
    latitudeElement.textContent = latitude;
    longitudeElement.textContent = longitude;
}

// 画像にExifデータを埋め込む関数
function addExifData(imgTag) {
    // Exifデータを設定
    const exifBytes = piexif.dump(exifData);
    imgTag.src = piexif.insert(exifBytes, imgTag.src);
}


// アップロードした画像のトリミングと回転をスタートする
function startModifyImageGeometry(tgtImage) {
    geometoryCompContainer.style.display = "flex";
    colorCompContainer.style.display = "none";
    originImage.style.display = "block";
    processedImage.style.display = "none";
    // 自動的にトリミングモードになる
    cropper = new Cropper(tgtImage, {
        aspectRatio: 1, // トリミングアスペクト比
        viewMode: 2,    // トリミングモード
    });
}
// トリミングと回転を終了し、変換後の画像を表示する
function endMofigyImageGeometry() {
    // トリミングされた画像データを取得
    const dstImageDataURL = cropper.getCroppedCanvas().toDataURL('image/jpeg');
    // Cropperのトリミングモードを解除
    cropper.destroy();
    geometoryCompContainer.style.display = "none";
    colorCompContainer.style.display = "flex";
    originImage.style.display = "none";
    processedImage.style.display = "block";
    // 画像データを表示
    return dstImageDataURL;
}

// cropperがバインドしている画像を回転させる
function rotateImage(angle) {
    cropper.rotate(angle);
}

// 輝度とコントラストを適用する関数
function applyBrightnessContrastSaturation(srcData, dstData, isSmallSize = false) {
    return new Promise((resolve, reject) => {            
        // 輝度とコントラストの値を取得
        if (!isSmallSize){
            brightness = brightnessRange.value - 100;  // -100 ~ 100
            contrast = contrastRange.value / 100;  // 0.0 ~ 2.0
            saturation = saturationRange.value / 100;  // 0.0 ~ 2.0                    
        }
        // 画像変数の作成
        const image = new Image();
        image.src = srcData.src;
        image.onload = function () {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            // 変換後の画像サイズ
            const width = (isSmallSize)? image.width : 600;
            const height = (isSmallSize)? image.height : 600;
            ctx.canvas.width = width;    
            ctx.canvas.height = height;  
            ctx.drawImage(image, 0, 0, image.width, image.height, 0, 0, width, height);
            let src = ctx.getImageData(0, 0, width, height);
            let dst = ctx.createImageData(width, height);
            for (let i = 0; i < src.data.length; i+=4) {
                const red = src.data[i];
                const green = src.data[i + 1];
                const blue = src.data[i + 2];

                // 輝度を適用
                const newRed = red + brightness;
                const newGreen = green + brightness;
                const newBlue = blue + brightness;

                // コントラストを適用
                const adjustedRed = contrast * (newRed - 128) + 128;
                const adjustedGreen = contrast * (newGreen - 128) + 128;
                const adjustedBlue = contrast * (newBlue - 128) + 128;

                // 彩度を適用
                const gray = adjustedRed * 0.3 + adjustedGreen * 0.59 + adjustedBlue * 0.11;
                const saturatedRed = saturation * (adjustedRed - gray) + gray;
                const saturatedGreen = saturation * (adjustedGreen - gray) + gray;
                const saturatedBlue = saturation * (adjustedBlue - gray) + gray;

                // 最終的なピクセル値を計算
                const finalRed = Math.min(255, Math.max(0, saturatedRed));
                const finalGreen = Math.min(255, Math.max(0, saturatedGreen));
                const finalBlue = Math.min(255, Math.max(0, saturatedBlue));

                // ピクセルデータを設定
                dst.data[i] = finalRed;
                dst.data[i + 1] = finalGreen;
                dst.data[i + 2] = finalBlue;
                dst.data[i + 3] = src.data[i + 3];  // アルファチャンネルをコピー
            }
            // 変更後のピクセルデータでCanvas上の内容を上書きする。
            ctx.putImageData(dst, 0, 0);
            // 変更後の画像データを表示
            dstData.src = canvas.toDataURL('image/jpeg');
            // Promiseを解決して非同期処理を完了させる
            resolve();                    
        };
    });
}


// GoogleMapを開く処理
function openGoogleMap(){
  if (cityInput.value == "" && prefectureInput.value == "") window.open('https://www.google.com/maps', '_blank');
  else if (cityInput.value != "") window.open('https://www.google.com/maps/place/' + cityInput.value, '_blank');
  else window.open('https://www.google.com/maps/place/' + prefectureInput.value, '_blank');
}


// GoogleMapのURLからGPS(MSG)を取得する
function getGpsFromUrl(){
  // クリップボードからテキストを取得
  navigator.clipboard.readText().then(function (inputGPSText) {
    const regex = /@([-0-9.]+),([-0-9.]+),([0-9.]+z)/;
    const match = inputGPSText.match(regex);
    if (match) {
      let latitudeDEG = match[1];
      let longitudeDEG = match[2];
      let latitudeDMS = degToDMS(latitudeDEG, 0);
      let longitudeDMS = degToDMS(longitudeDEG, 1);
      // EXIF, ブラウザ表示に反映する（別の処理に分けたい）FIXME
      exifData["GPS"]["1"] = latitudeDMS[3];
      exifData["GPS"]["2"] = [[latitudeDMS[0], 1], [latitudeDMS[1], 1], [latitudeDMS[2], 10000]];
      exifData["GPS"]["3"] = longitudeDMS[3];
      exifData["GPS"]["4"] = [[longitudeDMS[0], 1], [longitudeDMS[1], 1], [longitudeDMS[2], 10000]];
      console.log(latitudeDMS);
      latitudeElement.textContent = latitudeDEG; 
      longitudeElement.textContent = longitudeDEG; 
    } 
    else {
      console.log('URLから緯度経度情報が見つかりませんでした。');
    }
  }).catch(function (error) {
    console.error('クリップボードからテキストを取得できませんでした。', error);
  });
}


// DEG形式からDMS形式への変換関数
function degToDMS(deg, axis) {
    const absoluteDeg = Math.abs(deg);
    const degrees = Math.floor(absoluteDeg);
    const minutes = Math.floor((absoluteDeg - degrees) * 60);
    const seconds = parseInt(((absoluteDeg - degrees - minutes / 60) * 3600).toFixed(4) * 10000);
    const direction = (axis == 0)? ((deg >= 0) ? 'N' : 'S'): ((deg >= 0) ? 'E' : 'W');
    return [degrees, minutes, seconds, direction];
}

// DMS形式からDEG形式への変換関数
function dmsToDEG(dmsArr) {
    const degrees = dmsArr["0"][0];
    const minutes = dmsArr["1"][0];
    const seconds = dmsArr["2"][0] / dmsArr["2"][1];
    return degrees + minutes / 60.0 + seconds / 3600.0;
}


// 撮影日時Boxに入力された文字列を、写真の撮影日時として埋め込む処理
function convertDateFormat() {
  // テキストボックスから入力された文字列を取得
  const inputDateText = document.getElementById('inputDate').value;
  
  // 正規表現を使用して日付と時刻を抽出
  const regex = /(\d{4})(\d{2})(\d{2}) (\d{2})(\d{2})(\d{2})/;
  const match = inputDateText.match(regex);
  if (match) {
    // 正しい形式の文字列が入力された場合、Dateオブジェクトに変換
    const year = match[1];
    const month = match[2];
    const day = match[3];
    const hour = match[4];
    const minute = match[5];
    const second = match[6];
    const dateText = `${year}:${month}:${day} ${hour}:${minute}:${second}`;
    exifData["Exif"]["36867"] = dateText;
    exifData["Exif"]["36868"] = dateText;
    datetimeElement.textContent = dateText;
  }
  else{
    console.error('正しい形式の日付文字列を入力してください。');
  }
}






// // ファイルがアップロードされた時の処理
// fileInput.addEventListener('change', function (event) {
//     const file = event.target.files[0];
//     const imageUrl = URL.createObjectURL(file);
//     originImage.src = imageUrl;
//     // 画像情報の取得と画像の幾何変換を行う            
//     extractExifData(file);
//     startModifyImageGeometry(originImage);
// });

// 画像調整のスライダー処理を追加
brightnessRange.addEventListener('input', function () { applyBrightnessContrastSaturation(originImage, processedImage); });
contrastRange.addEventListener('input', function () { applyBrightnessContrastSaturation(originImage, processedImage); });
saturationRange.addEventListener('input', function () { applyBrightnessContrastSaturation(originImage, processedImage); });


// 行番号を検索ボタンが押された時の処理
function getManholeInfoFromServer(){
    showLoading();
    // 行番号の取得
    rowIndex = parseInt(rowIndexInput.value);
    google.script.run
      .withSuccessHandler(function(manholeInfo) {
        console.log(manholeInfo);
        areaInput.value = manholeInfo["area"];
        prefectureInput.value = manholeInfo["prefecture"];
        cityInput.value = manholeInfo["city"];
        cityHiraganaInput.value = manholeInfo["cityHiragana"];
        fileName = manholeInfo["fileName"];
        datetimeElement.textContent = manholeInfo["date"];
        latitudeElement.textContent = manholeInfo["latitude"];
        longitudeElement.textContent = manholeInfo["longitude"];
        originImage.src = manholeInfo["photoURL"];
        processedImage.src = manholeInfo["photoURL"];
        extractExifData(originImage.src);
        unshowLoading();
        startModifyImageGeometry(originImage);  // fixme
      })
      .getTargetRowManholeInfo(rowIndex);
  }


// トリミングモードを終了し、色補正モードに突入する
function finishGeometoryMode() {
    // トリミングされた画像データを取得
    const originImageDataURL = endMofigyImageGeometry();  
    // 画像データを表示
    originImage.src = originImageDataURL;
    applyBrightnessContrastSaturation(originImage, processedImage);
}

// オリジナル画像を表示する
checkOriginImageBtn.addEventListener('click', function () {
    if (checkOriginImageBtn.checked) {
        originImage.style.display = "block";
        processedImage.style.display = "none";
    }
    else {
        originImage.style.display = "none";
        processedImage.style.display = "block";
    }
});

// サーバーにマンホール情報をアップロードする
function uploadToServer() {
    // フォームの値を取得
    const area = areaInput.value;
    const prefecture = prefectureInput.value;
    const city = cityInput.value;
    const cityHiragana = cityHiraganaInput.value;
    const date = datetimeElement.textContent;
    const latitude = dmsToDEG(exifData["GPS"]["2"]) || '';
    const longitude = dmsToDEG(exifData["GPS"]["4"]) || '';
    const isPokefuta = pokefutaCheckbox.checked;
    const isColor = colorCheckbox.checked;
    const isChara = charaCheckbox.checked;
    const isDesign = designedCheckbox.checked;
    const isReliability = reliabilityCheckbox.checked;

    // 処理後の画像データを取得
    addExifData(processedImage);
    const processedImageData = processedImage.src;
    // // 画像データ、フォームの値をサーバーに送信する
    // google.script.run
    //     .withSuccessHandler(function(result) {console.log("serverResponse", result); })
    //     .withFailureHandler(function(error) { alert("サーバー側でエラーが発生しました: " + error.message); })
    //     .registerManhole(area, prefecture, city, cityHiragana, date, latitude, longitude, 
    //       isPokefuta, isChara, isColor, isDesign, isReliability, processedImageData);

    // 元サイズの画像データを作成。クライアント側がダウンロードできるようにする
    applyBrightnessContrastSaturation(originImage, downloadImage, true).then(() => {
        // 画像にExifを埋め込む
        addExifData(downloadImage);
        const downloadImageData = downloadImage.src;
    });

}


// サーバーにマンホール情報をアップロードする
function updateToServer() {
    showLoading();
    // フォームの値を取得
    const area = areaInput.value;
    const prefecture = prefectureInput.value;
    const city = cityInput.value;
    const cityHiragana = cityHiraganaInput.value;
    const date = datetimeElement.textContent;
    const latitude = dmsToDEG(exifData["GPS"]["2"]) || '';
    const longitude = dmsToDEG(exifData["GPS"]["4"]) || '';
    const isPokefuta = pokefutaCheckbox.checked;
    const isColor = colorCheckbox.checked;
    const isChara = charaCheckbox.checked;
    const isDesign = designedCheckbox.checked;
    const isReliability = reliabilityCheckbox.checked;

    // 処理後の画像データを取得
    addExifData(processedImage);
    const processedImageData = processedImage.src;
    // 画像データ、フォームの値をサーバーに送信する
    google.script.run
    .withSuccessHandler(function(result) {console.log("serverResponse", result); unshowLoading(); unshowLoading(); })
    .withFailureHandler(function(error) { alert("サーバー側でエラーが発生しました: " + error.message); })
    .editManhole(rowIndex, area, prefecture, city, cityHiragana, fileName, date, latitude, longitude, 
      isPokefuta, isChara, isColor, isDesign, isReliability, processedImageData);
}

function downloadProcessedImage() {
    // 元サイズの画像データを作成。クライアント側がダウンロードできるようにする
    applyBrightnessContrastSaturation(originImage, downloadImage, true).then(() => {
        // 画像にExifを埋め込む
        addExifData(downloadImage);
        const downloadImageData = downloadImage.src;
    });
}


// function initAll() {
//     processedImage.style.display = "none";
//     originImage.style.display = "none";
//     geometoryCompContainer.style.display = "none";
//     colorCompContainer.style.display = "none";
//     cropper = null;
//     exifData = null;
//     brightness = 0;
//     contrast = 1;
//     saturation = 1;
// }
// window.onload = initAll;
</script>


